(function(p){"undefined"!=typeof module?module.exports=p():"function"==typeof define&&"object"==typeof define.amd?define(p):this.micro=p()})(function(){function p(a){var c=[],b,d;for(d in a)if(a.hasOwnProperty(d)){var e=x.call(this,a[d]);e.name=d;if("boolean"===e.type){if(!b||8<=b.names.length)b={type:"bits",names:[],defaults:[],byteLength:1,defaultValue:0},c.push(b);b.names.push(e.name);b.defaults.push(e.defaultValue)}else c.push(e)}return c}function x(a){if("string"===typeof a)a=B.call(this,a);
else if("object"===typeof a)if(Array.isArray(a))a={type:"array",element:a[0]};else{if(a=y({},a),!a.type)throw Error("no 'type' specified for schema property");}else throw Error("schema property must be either string or object");a.type=a.type.toLowerCase();switch(a.type){case "int":case "float":a.byteLength=parseInt(a.byteLength)||("int"==a.type?4:8);a.defaultValue=a.defaultValue||0;a.unsigned=!!a.unsigned||!1;if(-1==[1,2,4,8].indexOf(a.byteLength))throw Error("invalid 'byteLength' of a number property (must be 1, 2, 4, or 8");
break;case "boolean":case "bit":a.type="boolean";a.defaultValue=!!a.defaultValue;break;case "string":a.encoding=a.encoding||"utf8";a.defaultValue=a.defaultValue||"";a.large=Boolean(a.large);break;case "array":if(!a.element)throw Error("must specify an 'element' attribute for a schema property of type: 'array'");a.element=x.call(this,a.element);a.defaultValue=a.defaultValue||[];if(a.byteLength){var c=a.byteLength/(a.element.byteLength||1);if(0!==c%1)throw Error("schema array byte length ("+a.byteLength+
") is not a multiple of its element's byte length ("+a.element.byteLength+")");a.maxLength=a.maxLength||c}else a.maxLength=a.maxLength||this.maxBufferLength/(a.element.byteLength||2);a.schema=[];for(c=0;c<a.maxLength;c++)a.schema.push(y({name:c},a.element));a.large=Boolean(a.large);break;case "object":if("object"==typeof a.schema)a.schema=p.call(this,a.schema);else if("string"!==typeof a.schema)throw Error("must specify a 'schema' attribute (of type string or object) for a schema property of type: 'object'");
a.defaultValue=a.defaultValue||null;a.allowNull=Boolean(a.allowNull);if(a.allowNull&&a.byteLength)throw Error("should not set 'allowNull' to true and add a specific 'byteLength' on a property of type 'object'");break;case "date":a.defaultValue=a.defaultValue||null;a.byteLength=8;break;case "enum":if(!a.values||!a.values.length)throw Error("must specify 'values' for property of type 'enum'");a.defaultValue=a.defaultValue||null;a.byteLength=1;-1==a.values.indexOf(a.defaultValue)&&a.values.push(a.defaultValue);
break;default:throw Error("invalid schema property type: '"+a.type+"'");}return a}function B(a){a=a.toLowerCase();switch(a){case "int8":case "byte":return{type:"int",byteLength:1};case "uint8":case "ubyte":return{type:"int",byteLength:1,unsigned:!0};case "int16":case "short":return{type:"int",byteLength:2};case "uint16":case "ushort":return{type:"int",byteLength:2,unsigned:!0};case "int32":case "int":return{type:"int",byteLength:4};case "uint32":case "uint":return{type:"int",byteLength:4,unsigned:!0};
case "int64":case "long":return{type:"int",byteLength:8};case "float8":return{type:"float",byteLength:1,precision:1};case "ufloat8":return{type:"float",byteLength:1,unsigned:!0,precision:1};case "float16":return{type:"float",byteLength:2,precision:1};case "ufloat16":return{type:"float",byteLength:2,unsigned:!0,precision:1};case "float32":case "float":return{type:"float",byteLength:4,precision:2};case "ufloat32":case "ufloat":return{type:"float",byteLength:4,unsigned:!0,precision:2};case "float64":case "double":return{type:"float",
byteLength:8};case "char":return{type:"string",byteLength:1};default:return{type:a}}}function z(a){for(var c=0,b=0;b<a.length;b++){var d=a[b],c=d.byteLength?c+d.byteLength:"object"===d.type?c+z.call(this,"object"===typeof d.schema?d.schema:this.getSchema(d.schema)):c+(d.large?65536:256);if(c>=this.maxBufferLength)return this.maxBufferLength}return c}function w(a,c,b){c=c||{};b=b||this.maxBufferLength;for(var d=new Buffer(b),e=0,h=a.length,p=0;p<h&&!(e>=b);p++){var k=a[p],f=k.type,m=k.byteLength,g=
c[k.name]||k.defaultValue;try{switch(f){case "int":case "float":"int"==f?g=Math.round(g):k.precision&&(g*=Math.pow(10,k.precision),g=Math.round(g));switch(m){case 1:k.unsigned?d.writeUInt8(g,e):d.writeInt8(g,e);break;case 2:k.unsigned?d.writeUInt16BE(g,e):d.writeInt16BE(g,e);break;case 4:k.unsigned?d.writeUInt32BE(g,e):d.writeInt32BE(g,e);break;case 8:d.writeDoubleBE(g,e)}break;case "bits":for(var l=k.names,A=l.length,f=0;f<A;f++)var r=c[l[f]],r="undefined"==typeof r?k.defaults[f]:!!r,g=g+(r?1<<A-
1-f:0);d.writeUInt8(g,e);break;case "string":m||(m=Buffer.byteLength(g,k.encoding),k.large?(d.writeUInt16BE(m,e),e+=2):(d.writeUInt8(m,e),e++));d.write(g,e,m,k.encoding);break;case "array":var s=g.length<k.schema.length?k.schema.slice(0,g.length):k.schema,t=w.call(this,s,g,m);m||(m=t.length,k.large?(d.writeUInt16BE(s.length,e),e+=2):(d.writeUInt8(s.length,e),e++));t.copy(d,e);break;case "object":k.schema="object"===typeof k.schema?k.schema:this.getSchema(k.schema);if(!k.schema)throw Error("object schema has not been registered.");
if(k.allowNull)if(null==g){d.writeUInt8(1,e);m=1;break}else d.writeUInt8(0,e),e++;var u=w.call(this,k.schema,g,m),m=m||u.length;u.copy(d,e);break;case "enum":var q=k.values.indexOf(g);-1==q&&(q=k.values.indexOf(k.defaultValue));d.writeUInt8(q,e);break;case "date":if(g){var n=(new Date(g)).getTime();isNaN(n)&&(console.warn("Unable to parse date value '"+g+" for '"+k.name+"'. Setting to null."),n=0);d.writeDoubleBE(n,e)}else d.writeDoubleBE(0,e);break;default:throw Error("unknown schema type: '"+f+
"'");}}catch(v){throw Error("while writing schema property '"+k.name+"("+g+"): "+v.message);}e+=m}e<b&&(d=d.slice(0,e));return d}function v(a,c,b,d){b=b||{};for(var e=c.length,h=0,p=a.length,k=0;k<p&&!(h>=e);k++){var f=a[k],m=f.type,g=f.byteLength,l=void 0;try{switch(m){case "int":case "float":switch(g){case 1:l=f.unsigned?c.readUInt8(h):c.readInt8(h);break;case 2:l=f.unsigned?c.readUInt16BE(h):c.readInt16BE(h);break;case 4:l=f.unsigned?c.readUInt32BE(h):c.readInt32BE(h);break;case 8:l=c.readDoubleBE(h)}"float"==
m&&f.precision&&(l/=Math.pow(10,f.precision));b[f.name]=l;break;case "bits":for(var l=c.readUInt8(h),n=f.names,r=n.length,m=0;m<r;m++){var s=1<<r-1-m;l>=s?(b[n[m]]=!0,l-=s):b[n[m]]=!1}break;case "string":g||(f.large?(g=c.readUInt16BE(h),h+=2):(g=c.readUInt8(h),h++));l=c.toString(f.encoding,h,h+g);b[f.name]=l;break;case "array":var t,u;if(g)t=c.slice(h,h+g),u=f.schema;else{var q;f.large?(q=c.readUInt16BE(h),h+=2):(q=c.readUInt8(h),h++);t=c.slice(h);u=q<f.schema.length?f.schema.slice(0,q):f.schema}l=
v.call(this,u,t,[],!0);g=l.byteLength;b[f.name]=l.data;break;case "object":if(f.allowNull){if(0<c.readUInt8(h)){b[f]=null;g=1;break}h++}f.schema="object"===typeof f.schema?f.schema:this.getSchema(f.schema);if(!f.schema)throw Error("Object schema: '"+f.schema+"' has not been registered.");var w=g?c.slice(h,h+g):c.slice(h),l=v.call(this,f.schema,w,{},!0),g=l.byteLength;b[f.name]=l.data;break;case "enum":var x=c.readUInt8(h);b[f.name]=f.values[x];break;case "date":l=c.readDoubleBE(h);b[f.name]=0<l?(new Date(l)).toUTCString():
null;break;default:throw Error("unknown schema type: '"+m+"'");}}catch(y){throw Error("while reading schema property '"+f.name+"':  "+y.message);}h+=g}return d?{byteLength:h,data:b}:b}function y(a,c){if(!c||"object"!==typeof c)return a;for(var b=Object.keys(c),d=b.length;d--;)a[b[d]]=c[b[d]];return a}var n=function(a){this.maxBufferLength=a||1024;this._schemaData={};this._schemaNames=[]};n.prototype.register=function(a,c,b){if("object"!==typeof a)throw Error("schema '"+c+"' must be an object");if("string"!==
typeof c)for(var d in a)a.hasOwnProperty(d)&&this.register(a[d],d,c);else try{b=b||{};b.serializeType="boolean"===typeof b.serializeType?b.serializeType:!0;b.typeId="number"==typeof b.typeId?b.typeId:this._schemaNames.length;if(b.serializeType&&(0<b.typeId%1||0>b.typeId||255<b.typeId))throw Error("invalid typeId '"+b.typeId+"' (must be an integer between 0-255");a=p.call(this,a);this._schemaData[c]={schema:a,serializeType:b.serializeType,typeId:b.typeId,size:b.maxBytes||z.call(this,a)};b.serializeType&&
(this._schemaNames[b.typeId]=c);return b.typeId}catch(e){throw Error("unable to parse schema '"+c+"' :"+e.message);}};n.prototype.getSchema=function(a){return(a=this._schemaData[a])?a.schema:null};n.prototype.toBinary=function(a,c,b){"string"===typeof a&&(a=JSON.parse(a));var d=this._schemaData[c];if(!d)throw Error("no schema with name: '"+c+'" has been registered.');b=b||d.size;a=w.call(this,d.schema,a,b);a.length>=this.maxBufferLength&&console.warn("Max Buffer Length reached ("+this.maxBufferLength+
")! You may want to increase 'maxBufferLength' on this micro serializer instance. ");d.serializeType&&(a=Buffer.concat([new Buffer([d.typeId]),a],a.length+1));return a};n.prototype.toJSON=function(a,c){var b;if(c){b=this._schemaData[c];if(!b)throw Error("could not find a registered schema with name: '"+c+'"');b.serializeType&&(a=a.slice(1));b=v.call(this,b.schema,a)}else{c=this._schemaNames[a[0]];if(!c)throw Error("could not derive a matching registered schema from the binary data");b=this._schemaData[c];
a=a.slice(1);b=v.call(this,b.schema,a);b._type=c}return b};return new n});
