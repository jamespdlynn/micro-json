(function(r,p){"undefined"!=typeof module?module.exports=p():"function"==typeof define&&"object"==typeof define.amd?define(r,p):this.micro=p()})("microjs",function(){function r(a){var f=[],b,g;for(g in a)if(a.hasOwnProperty(g)){var d=p(a[g]);d.name=g;if("boolean"===d.type){if(!b||8<=b.names.length)b={type:"bits",names:[],defaults:[],byteLength:1,defaultValue:0},f.push(b);b.names.push(d.name);b.defaults.push(d.defaultValue)}else f.push(d)}if(!f.length)throw Error("Schema must have attributes");return f}
function p(a){if("string"===typeof a)a=v(a);else if("object"===typeof a)if(Array.isArray(a))a={type:"array",element:a[0]};else{if(a=s({},a),!a.type)throw Error("No type specified for schema attribute");}else throw Error("Schema property must be either string or object");a.type=a.type.toLowerCase();switch(a.type){case "int":case "float":a.byteLength=parseInt(a.byteLength)||4;a.defaultValue=a.defaultValue||0;a.unsigned=!!a.unsigned||!1;if(-1==[1,2,4,8].indexOf(a.byteLength))throw Error("Invalid bytesize of a schema property of type: '"+
a.type+"' (must be 1, 2, 4, or 8");break;case "boolean":case "bit":a.type="boolean";a.defaultValue=!!a.defaultValue;break;case "string":a.encoding=a.encoding||"utf8";a.defaultValue=a.defaultValue||"";break;case "array":if(!a.element)throw Error("Must specify an 'element' attribute for a schema property of type: 'array'");a.element=p(a.element);a.defaultValue=a.defaultValue||[];a.schema=[];if(a.byteLength&&a.element.byteLength){var f=a.byteLength/a.element.byteLength;if(0!==f%1)throw Error("Schema array byte length ("+
a.byteLength+") is not a multiple of its element's byte length ("+a.element.byteLength+")");for(var b=0;b<f;b++)a.schema.push(s({name:b},a.element))}else for(b=0;128>b;b++)a.schema.push(s({name:b},a.element));break;case "object":if("object"==typeof a.schema)a.schema=r.call(this,a.schema);else if("string"!==typeof a.schema)throw Error("Must specify a 'schema' attribute (of type string or object) for a schema property of type: 'object'");a.defaultValue=a.defaultValue||{};break;default:throw Error("Invalid schema property type: '"+
a.type+"'");}return a}function v(a){a=a.toLowerCase();switch(a){case "int8":case "byte":return{type:"int",byteLength:1};case "uint8":case "ubyte":return{type:"int",byteLength:1,unsigned:!0};case "int16":case "short":return{type:"int",byteLength:2};case "uint16":case "ushort":return{type:"int",byteLength:2,unsigned:!0};case "int32":case "int":return{type:"int",byteLength:4};case "uint32":case "uint":return{type:"int",byteLength:4,unsigned:!0};case "int64":case "long":return{type:"int",byteLength:8};
case "float8":return{type:"float",byteLength:1,precision:1};case "ufloat8":return{type:"float",byteLength:1,unsigned:!0,precision:1};case "float16":return{type:"float",byteLength:2,precision:1};case "ufloat16":return{type:"float",byteLength:2,unsigned:!0,precision:1};case "float32":case "float":return{type:"float",byteLength:4,precision:2};case "ufloat32":case "ufloat":return{type:"float",byteLength:4,unsigned:!0,precision:2};case "float64":case "double":return{type:"float",byteLength:8};case "char":return{type:"string",
byteLength:1,encoding:"utf8"};default:return{type:a}}}function t(a,f,b){b=b||this.maxBufferLength;for(var g=new Buffer(b),d=0,m=0;m<a.length&&!(d>=b);m++){var e=a[m],k=e.type,h=e.byteLength,c=f[e.name]||e.defaultValue;switch(k){case "int":case "float":"int"==k?c=Math.round(c):e.precision&&(c*=Math.pow(10,e.precision),c=Math.round(c));switch(h){case 1:e.unsigned?g.writeUInt8(c,d):g.writeInt8(c,d);break;case 2:e.unsigned?g.writeUInt16BE(c,d):g.writeInt16BE(c,d);break;case 4:e.unsigned?g.writeUInt32BE(c,
d):g.writeInt32BE(c,d);break;case 8:g.writeDoubleBE(c,d)}break;case "bits":for(var k=e.names,l=0;l<k.length;l++)var n=f[k[l]],n="undefined"==typeof n?e.defaults[l]:!!n,c=c+(n?1<<k.length-1-l:0);g.writeUInt8(c,d);break;case "string":h||(h=Buffer.byteLength(c,e.encoding),g.writeUInt8(h,d),d++);g.write(c,d,h,e.encoding);break;case "array":e=c.length<e.schema.length?e.schema.slice(0,c.length):e.schema;c=t.call(this,e,c,h);h||(h=c.length,g.writeUInt8(h,d),d++);c.copy(g,d);break;case "object":e.schema=
"object"===typeof e.schema?e.schema:this.getSchema(e.schema);if(!e.schema)throw Error("Object schema: '"+e.schema+"' has not been registered.");c=t.call(this,e.schema,c,h);h=h||c.length;c.copy(g,d);break;default:throw Error("Unknown schema type: '"+k+"'");}d+=h}d<b&&(g=g.slice(0,d));return g}function u(a,f,b){b=b||{_packet:{}};for(var g=f.length,d=0,m=0;m<a.length&&!(d>=g);m++){var e=a[m],k=e.type,h=e.byteLength,c=void 0;switch(k){case "int":case "float":switch(h){case 1:c=e.unsigned?f.readUInt8(d):
f.readInt8(d);break;case 2:c=e.unsigned?f.readUInt16BE(d):f.readInt16BE(d);break;case 4:c=e.unsigned?f.readUInt32BE(d):f.readInt32BE(d);break;case 8:c=f.readDoubleBE(d)}"float"==k&&e.precision&&(c/=Math.pow(10,e.precision));b[e.name]=c;break;case "bits":for(var c=f.readUInt8(d),k=e.names,l=0;l<e.names.length;l++){var n=1<<k.length-1-l;c>=n?(b[k[l]]=!0,c-=n):b[k[l]]=!1}break;case "string":h||(h=f.readUInt8(d),d++);c=f.toString(e.encoding,d,d+h);b[e.name]=c;break;case "array":h||(h=f.readUInt8(d),d++);
c=f.slice(d,d+h);c=u.call(this,e.schema,c,[]);b[e.name]=c;break;case "object":e.schema="object"===typeof e.schema?e.schema:this.getSchema(e.schema);if(!e.schema)throw Error("Object schema: '"+e.schema+"' has not been registered.");c=h?f.slice(d,d+h):f.slice(d);c=u.call(this,e.schema,c);h||(h=c._packet.byteLength);delete c._packet;b[e.name]=c}d+=h}b._packet&&(b._packet.byteLength=d);return b}function s(a,f){if(!f||"object"!==typeof f)return a;for(var b=Object.keys(f),g=b.length;g--;)a[b[g]]=f[b[g]];
return a}var q=function(a){this.maxBufferLength=a||1024;this._schemaData={};this._typeIndices=[]};q.prototype.register=function(a,f,b){if("object"===typeof a)for(var g in a)a.hasOwnProperty(g)&&this.register(g,a[g],f||b);else b=b||{},b.serializeType="boolean"===typeof b.serializeType?b.serializeType:!0,b.typeIndex="number"==typeof b.typeIndex?b.index:this._typeIndices.length,this._schemaData[a]={schema:r.call(this,f),serializeType:b.serializeType,typeIndex:b.typeIndex},b.serializeType&&(this._typeIndices[b.typeIndex]=
a)};q.prototype.getSchema=function(a){return(a=this._schemaData[a])?a.schema:null};q.prototype.toBinary=function(a,f,b){var g=this._schemaData[f];if(!g)throw Error("No Schema with name: '"+f+'" has been registered.');a=t.call(this,g.schema,a,b);g.serializeType&&(a=Buffer.concat([new Buffer([g.typeIndex]),a]));return a};q.prototype.toJSON=function(a,f){var b;if(f){b=this._schemaData[f];if(!b)throw Error("Could not find a registered schema with name: '"+f+'"');if(b.serializeType){if(b.typeIndex!==a[0])throw Error("Serialized type index derived from binary data ("+
a[0]+") does not match that for '"+f+"' ("+b.typeIndex+")");a=a.slice(1)}}else{f=this._typeIndices[a[0]];if(!f)throw Error("Could not derive a matching registered schema from the binary data");b=this._schemaData[f];a=a.slice(1)}b=u.call(this,b.schema,a);b._packet.type=f;return b};return new q});
