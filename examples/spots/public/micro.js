(function(p){"undefined"!=typeof module?module.exports=p():"function"==typeof define&&"object"==typeof define.amd?define(p):this.micro=p()})(function(){function p(a){var b=[],c,d;for(d in a)if(a.hasOwnProperty(d)){var f=t.call(this,a[d]);f.name=d;if("boolean"===f.type){if(!c||8<=c.names.length)c={type:"bits",names:[],defaults:[],byteLength:1,defaultValue:0},b.push(c);c.names.push(f.name);c.defaults.push(f.defaultValue)}else b.push(f)}if(!b.length)throw Error("Schema must have attributes");return b}
function t(a){if("string"===typeof a)a=v.call(this,a);else if("object"===typeof a)if(Array.isArray(a))a={type:"array",element:a[0]};else{if(a=u({},a),!a.type)throw Error("No type specified for schema attribute");}else throw Error("Schema property must be either string or object");a.type=a.type.toLowerCase();switch(a.type){case "int":case "float":a.byteLength=parseInt(a.byteLength)||4;a.defaultValue=a.defaultValue||0;a.unsigned=!!a.unsigned||!1;if(-1==[1,2,4,8].indexOf(a.byteLength))throw Error("Invalid bytesize of a schema property of type: '"+
a.type+"' (must be 1, 2, 4, or 8");break;case "boolean":case "bit":a.type="boolean";a.defaultValue=!!a.defaultValue;break;case "string":a.encoding=a.encoding||"utf8";a.defaultValue=a.defaultValue||"";break;case "array":if(!a.element)throw Error("Must specify an 'element' attribute for a schema property of type: 'array'");a.element=t.call(this,a.element);a.defaultValue=a.defaultValue||[];if(a.byteLength){var b=a.byteLength/(a.element.byteLength||1);if(0!==b%1)throw Error("Schema array byte length ("+
a.byteLength+") is not a multiple of its element's byte length ("+a.element.byteLength+")");a.maxLength=a.maxLength||b}else a.maxLength=a.maxLength||this.maxBufferLength/(a.element.byteLength||2);a.schema=[];for(b=0;b<a.maxLength;b++)a.schema.push(u({name:b},a.element));break;case "object":if("object"==typeof a.schema)a.schema=p.call(this,a.schema);else if("string"!==typeof a.schema)throw Error("Must specify a 'schema' attribute (of type string or object) for a schema property of type: 'object'");
a.defaultValue=a.defaultValue||{};break;default:throw Error("Invalid schema property type: '"+a.type+"'");}return a}function v(a){a=a.toLowerCase();switch(a){case "int8":case "byte":return{type:"int",byteLength:1};case "uint8":case "ubyte":return{type:"int",byteLength:1,unsigned:!0};case "int16":case "short":return{type:"int",byteLength:2};case "uint16":case "ushort":return{type:"int",byteLength:2,unsigned:!0};case "int32":case "int":return{type:"int",byteLength:4};case "uint32":case "uint":return{type:"int",
byteLength:4,unsigned:!0};case "int64":case "long":return{type:"int",byteLength:8};case "float8":return{type:"float",byteLength:1,precision:1};case "ufloat8":return{type:"float",byteLength:1,unsigned:!0,precision:1};case "float16":return{type:"float",byteLength:2,precision:1};case "ufloat16":return{type:"float",byteLength:2,unsigned:!0,precision:1};case "float32":case "float":return{type:"float",byteLength:4,precision:2};case "ufloat32":case "ufloat":return{type:"float",byteLength:4,unsigned:!0,precision:2};
case "float64":case "double":return{type:"float",byteLength:8};case "char":return{type:"string",byteLength:1};default:return{type:a}}}function r(a,b,c){c=c||this.maxBufferLength;for(var d=new Buffer(c),f=0,h=0;h<a.length&&!(f>=c);h++){var k=a[h],g=k.type,m=k.byteLength,e=b[k.name]||k.defaultValue;switch(g){case "int":case "float":"int"==g?e=Math.round(e):k.precision&&(e*=Math.pow(10,k.precision),e=Math.round(e));switch(m){case 1:k.unsigned?d.writeUInt8(e,f):d.writeInt8(e,f);break;case 2:k.unsigned?
d.writeUInt16BE(e,f):d.writeInt16BE(e,f);break;case 4:k.unsigned?d.writeUInt32BE(e,f):d.writeInt32BE(e,f);break;case 8:d.writeDoubleBE(e,f)}break;case "bits":for(var g=k.names,l=0;l<g.length;l++)var n=b[g[l]],n="undefined"==typeof n?k.defaults[l]:!!n,e=e+(n?1<<g.length-1-l:0);d.writeUInt8(e,f);break;case "string":m||(m=Buffer.byteLength(e,k.encoding),d.writeUInt8(m,f),f++);d.write(e,f,m,k.encoding);break;case "array":k=e.length<k.schema.length?k.schema.slice(0,e.length):k.schema;e=r.call(this,k,e,
m);m||(m=e.length,d.writeUInt8(m,f),f++);e.copy(d,f);break;case "object":k.schema="object"===typeof k.schema?k.schema:this.getSchema(k.schema);if(!k.schema)throw Error("Object schema: '"+k.schema+"' has not been registered.");e=r.call(this,k.schema,e,m);m=m||e.length;e.copy(d,f);break;default:throw Error("Unknown schema type: '"+g+"'");}f+=m}f<c&&(d=d.slice(0,f));return d}function s(a,b,c,d){c=c||{};for(var f=b.length,h=0,k=0;k<a.length&&!(h>=f);k++){var g=a[k],m=g.type,e=g.byteLength,l=void 0;switch(m){case "int":case "float":switch(e){case 1:l=
g.unsigned?b.readUInt8(h):b.readInt8(h);break;case 2:l=g.unsigned?b.readUInt16BE(h):b.readInt16BE(h);break;case 4:l=g.unsigned?b.readUInt32BE(h):b.readInt32BE(h);break;case 8:l=b.readDoubleBE(h)}"float"==m&&g.precision&&(l/=Math.pow(10,g.precision));c[g.name]=l;break;case "bits":for(var l=b.readUInt8(h),m=g.names,n=0;n<g.names.length;n++){var p=1<<m.length-1-n;l>=p?(c[m[n]]=!0,l-=p):c[m[n]]=!1}break;case "string":e||(e=b.readUInt8(h),h++);l=b.toString(g.encoding,h,h+e);c[g.name]=l;break;case "array":e||
(e=b.readUInt8(h),h++);l=b.slice(h,h+e);l=s.call(this,g.schema,l,[]);c[g.name]=l;break;case "object":g.schema="object"===typeof g.schema?g.schema:this.getSchema(g.schema);if(!g.schema)throw Error("Object schema: '"+g.schema+"' has not been registered.");l=e?b.slice(h,h+e):b.slice(h);l=s.call(this,g.schema,l,{},!0);e=e||l._byteLength;delete l._byteLength;c[g.name]=l}h+=e}d&&(c._byteLength=h);return c}function u(a,b){if(!b||"object"!==typeof b)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=
b[c[d]];return a}var q=function(a){this.maxBufferLength=a||1024;this._schemaData={};this._schemaNames=[]};q.prototype.register=function(a,b,c,d){if("object"!==typeof a)throw Error("Schema '"+b+"' must be an object");if("string"!==typeof b)for(var f in a)a.hasOwnProperty(f)&&this.register(a[f],f,b);else{c="boolean"===typeof c?c:!0;d="number"==typeof d?index:this._schemaNames.length;if(c&&(0<d%1||0>d||255<d))throw Error("Error parsing schema '"+b+"' : Invalid typeId '"+d+"' (must be an integer between 0-255");
try{this._schemaData[b]={schema:p.call(this,a),serializeType:c,typeId:d},c&&(this._schemaNames[d]=b)}catch(h){throw Error("Error parsing schema '"+b+"' :"+h.message);}}};q.prototype.getSchema=function(a){return(a=this._schemaData[a])?a.schema:null};q.prototype.toBinary=function(a,b,c){if(!b)throw Error("Must specify a schema name");var d=this._schemaData[b];if(!d)throw Error("No Schema with name: '"+b+'" has been registered.');a=r.call(this,d.schema,a,c);d.serializeType&&(a=Buffer.concat([new Buffer([d.typeId]),
a],a.length+1));return a};q.prototype.toJSON=function(a,b){var c;if(b){c=this._schemaData[b];if(!c)throw Error("Could not find a registered schema with name: '"+b+'"');c.serializeType&&(a=a.slice(1))}else{b=this._schemaNames[a[0]];if(!b)throw Error("Could not derive a matching registered schema from the binary data");c=this._schemaData[b];a=a.slice(1)}c=s.call(this,c.schema,a);c._type=b;return c};return new q});
